(function(p){var d=p.phpfpm={};d.url=function(d){this.url=d;this.addQueryString=function(c,a){var b=RegExp("([?|&])"+c+"=.*?(&|#|$)(.*)","gi");b.test(this.url)?this.url=this.url.replace(b,"$1"+c+(a?"="+a:"")+"$2$3"):(b=this.url.split("#"),this.url=b[0]+(-1!==this.url.indexOf("?")?"&":"?")+c,a&&(this.url+="="+a),b[1]&&(this.url+="#"+b[1]));return this};this.toString=function(){return this.url};return this};d.status=function(l,c){this.url=d.url(l).addQueryString("json").toString();this.delay=c;this.data=
{};this.previousData={};this.lastFetch=+new Date;this.fetch=function(a){this.lastFetch=+new Date;var b=this;d3.json(this.url,function(h){b.previousData=b.data;b.data=h;a&&a(b)});return this};this.get=function(){this.lastFetch+this.delay<+new Date&&this.fetch();return this.data};this.getPrevious=function(){return this.previousData};return this};d.monitoring=function(l,c,a){this.context=cubism.context().serverDelay(0).clientDelay(0).step(c).size(a);this.context.on("focus",function(b){d3.selectAll(".value").style("right",
null==b?null:a-b+"px")});this.start=+new Date;this.status=d.status(l,c);this.getMetric=function(b,a){var n=this;return this.context.metric(function(e,a,c,m){var g=[];e=+e;if(e>=n.start)for(a=+a;e<a;){e+=c;var d=n.status.get()[b];d&&g.push(d)}m(null,g)},a?a:b)};this.getDiffMetric=function(b,a){var d=this;return this.context.metric(function(a,c,f,m){var g=[];a=+a;if(a>=d.start)for(c=+c;a<c;){a+=f;var h=d.status.get()[b]-d.status.getPrevious()[b];h&&g.push(h)}m(null,g)},a)};this.getData=function(){return[this.getMetric("accepted conn",
"total conn"),this.getDiffMetric("accepted conn","new conn"),this.getMetric("active processes"),this.getDiffMetric("active processes","~ active processes"),this.getMetric("idle processes"),this.getDiffMetric("idle processes","~ idle processes"),this.getMetric("total processes"),this.getDiffMetric("total processes","~ total processes"),this.getMetric("max active processes"),this.getMetric("max children reached"),this.getMetric("listen queue"),this.getDiffMetric("listen queue","~ listen queue"),this.getMetric("max listen queue")]};
this.display=function(a,d){this.start=+new Date;if(a=d3.select(a)){var c="phpfpm";d&&(c+=" "+d);a.attr("class",c);var e=a.append("h1").attr("class","title");this.status.fetch(function(a){e.text("Pool "+a.data.pool+" ("+a.data["process manager"]+") started since "+new Date(1E3*a.data["start time"]))});var k=a.append("div").attr("class","graphe"),f=this;k.call(function(a){k.append("div").attr("class","axis").call(f.context.axis().orient("top"));k.selectAll(".horizon").data(f.getData()).enter().append("div").attr("class",
function(a){return"horizon "+a.toString().replace(/\s+/g,"")}).call(function(a){return a=f.context.horizon().format(d3.format("d")).colors("#0d58f1 #568bf5 #9fbdfa #e8effe #feefe8 #fabd9f #f58b56 #f1580d".split(" "))(a)});k.append("div").attr("class","rule").call(f.context.rule())})}};return this}})(cubism);
